<div class="page">
    <div class="page-header">
        <button mat-icon-button (click)="goBack()" class="back-button" matTooltip="Back to Dashboard">
            <mat-icon>arrow_back</mat-icon>
        </button>
        <h2>Linux Morning Checklist</h2>
    </div>

    <mat-card class="filters">
        <div class="row">
            <mat-form-field appearance="outline">
                <mat-label>Select Date (Today to 7 Days Ago)</mat-label>
                <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDate"
                    (dateChange)="onDateChange($event.value)" [min]="minDate" [max]="maxDate"
                    [matDatepickerFilter]="dateFilter" [disabled]="loadingDates" placeholder="Select a date">
                <mat-datepicker-toggle matSuffix [for]="picker" [disabled]="loadingDates"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-hint *ngIf="loadingDates">Loading available dates...</mat-hint>
                <mat-hint *ngIf="!loadingDates">Select a date from today to 7 days ago</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Application</mat-label>
                <mat-select [(ngModel)]="filters.application_name" (selectionChange)="onApplicationChange()">
                    <mat-option [value]="undefined">All</mat-option>
                    <mat-option *ngFor="let key of (applicationOwnerMap | keyvalue)" [value]="key.key">
                        {{ key.key }}
                    </mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>Asset Owner</mat-label>
                <mat-select [(ngModel)]="filters.asset_owner" (selectionChange)="loadSummary()">
                    <mat-option [value]="undefined">All</mat-option>
                    <mat-option *ngFor="let owner of availableOwners" [value]="owner">{{ owner }}</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-slide-toggle [(ngModel)]="filters.show_errors_only" (change)="loadSummary()">Show only
                errors</mat-slide-toggle>

            <button mat-icon-button (click)="resetFilters()" matTooltip="Reset Filters">
                <mat-icon>restart_alt</mat-icon>
            </button>

            <!-- Checklist Validation Action -->
            <div class="checklist-validation">
                <div *ngIf="checklistValidation" class="validated-banner">
                    <mat-icon>verified</mat-icon>
                    <span>
                        Checklist Validated by <strong>{{checklistValidation.validate_by}}</strong>
                        on {{checklistValidation.validated_at | date:'medium':'+0530'}}
                        <span
                            *ngIf="checklistValidation.validate_comment">("{{checklistValidation.validate_comment}}")</span>
                    </span>
                    <button mat-icon-button color="warn" (click)="undoChecklistValidation()"
                        matTooltip="Undo Checklist Validation" class="undo-button">
                        <mat-icon>undo</mat-icon>
                    </button>
                </div>
                <button mat-raised-button color="primary"
                    *ngIf="!checklistValidation && !loadingChecklistValidation && summary"
                    (click)="validateChecklist()">
                    <mat-icon>done_all</mat-icon> Validate Checklist
                </button>
                <mat-spinner *ngIf="loadingChecklistValidation" diameter="24"></mat-spinner>
            </div>

            <span class="spacer"></span>

            <button mat-stroked-button color="primary" (click)="exportSummary()">
                <mat-icon>download</mat-icon>
                Export Excel
            </button>

        </div>
    </mat-card>

    <mat-tab-group [(selectedIndex)]="selectedTabIndex" (selectedTabChange)="onTabChange($event.index)"
        animationDuration="0ms">
        <mat-tab label="Summary">
            <div class="tab-content">
                <mat-card class="widget" *ngIf="selectedDate">
                    <div class="widget-header">
                        <h3>Server Reachability</h3>
                        <mat-progress-spinner *ngIf="loadingSummary" diameter="24"
                            mode="indeterminate"></mat-progress-spinner>
                    </div>
                    <div class="widget-row">
                        <div (click)="showReachabilityDetails('total')" class="widget-item">
                            <div class="value">{{ summary?.reachability?.total ?? 0 }}</div>
                            <div class="label">Total servers</div>
                        </div>
                        <div (click)="showReachabilityDetails('reachable')" class="widget-item">
                            <div class="value success">{{ summary?.reachability?.reachable ?? 0 }}</div>
                            <div class="label">Reachable</div>
                        </div>
                        <div (click)="showReachabilityDetails('failed')" class="widget-item">
                            <div class="value warn">{{ summary?.reachability?.failed ?? 0 }}</div>
                            <div class="label">Failed</div>
                        </div>
                        <div (click)="showReachabilityDetails('unreachable')" class="widget-item">
                            <div class="value error">{{ summary?.reachability?.unreachable ?? 0 }}</div>
                            <div class="label">Unreachable</div>
                        </div>
                    </div>
                    <div *ngIf="!summary && !loadingSummary" class="widget-empty">
                        <p>No data available for selected date</p>
                    </div>
                </mat-card>

                <mat-card class="summary-card">
                    <div class="card-header">
                        <div>
                            <h3>Summary for {{ selectedDate | date:'mediumDate' }}</h3>
                            <p class="subtitle">Grouped by application and owner</p>
                        </div>
                        <div class="header-actions">
                            <button mat-raised-button color="primary" [disabled]="selectedGroups.size === 0"
                                (click)="validateSelectedGroups()" *ngIf="selectedGroups.size > 0">
                                <mat-icon>done_all</mat-icon> Validate Selected Groups ({{selectedGroups.size}})
                            </button>
                            <mat-progress-spinner diameter="36" mode="indeterminate"
                                *ngIf="loadingSummary"></mat-progress-spinner>
                        </div>
                    </div>

                    <table mat-table [dataSource]="groups" class="mat-elevation-z1">
                        <!-- Select Column -->
                        <ng-container matColumnDef="select">
                            <th mat-header-cell *matHeaderCellDef>
                                <mat-checkbox (change)="$event ? masterGroupToggle() : null"
                                    [checked]="isAllGroupsSelected() && groups.length > 0"
                                    [indeterminate]="selectedGroups.size > 0 && !isAllGroupsSelected()">
                                </mat-checkbox>
                            </th>
                            <td mat-cell *matCellDef="let row">
                                <mat-checkbox (click)="$event.stopPropagation()"
                                    (change)="$event ? toggleGroupSelection(row) : null"
                                    [checked]="selectedGroups.has(row)" [disabled]="row.error_count === 0">
                                </mat-checkbox>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="srNo">
                            <th mat-header-cell *matHeaderCellDef>Sr No</th>
                            <td mat-cell *matCellDef="let row; let i = index">{{i + 1}}</td>
                        </ng-container>

                        <ng-container matColumnDef="application">
                            <th mat-header-cell *matHeaderCellDef>Application</th>
                            <td mat-cell *matCellDef="let row">{{ row.application_name }}</td>
                        </ng-container>

                        <ng-container matColumnDef="owner">
                            <th mat-header-cell *matHeaderCellDef>Owner</th>
                            <td mat-cell *matCellDef="let row">{{ row.asset_owner || '—' }}</td>
                        </ng-container>

                        <ng-container matColumnDef="success">
                            <th mat-header-cell *matHeaderCellDef>Success</th>
                            <td mat-cell *matCellDef="let row">
                                <button mat-button color="primary" (click)="viewDetails('success', row)">{{
                                    row.success_count
                                    }}</button>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="error">
                            <th mat-header-cell *matHeaderCellDef>Error</th>
                            <td mat-cell *matCellDef="let row">
                                <button mat-button color="warn" (click)="viewDetails('error', row)">{{ row.error_count
                                    }}</button>
                            </td>
                        </ng-container>

                        <tr mat-header-row
                            *matHeaderRowDef="['select', 'srNo','application','owner','success','error']"></tr>
                        <tr mat-row
                            *matRowDef="let row; columns: ['select', 'srNo','application','owner','success','error'];">
                        </tr>

                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" [attr.colspan]="4" style="text-align: center; padding: 24px;">
                                <p *ngIf="!loadingSummary">No data available for the selected date and filters.</p>
                                <p *ngIf="loadingSummary">Loading...</p>
                            </td>
                        </tr>
                    </table>
                </mat-card>
            </div>
        </mat-tab>

        <mat-tab label="Details">
            <div class="tab-content">
                <mat-card class="details-card">
                    <div class="card-header">
                        <div>
                            <h3>{{ (selectedStatus || selectedReachability || '') | titlecase }} Details</h3>
                            <p class="subtitle" *ngIf="selectedStatus || selectedReachability">Hostname wise view</p>
                            <p class="subtitle" *ngIf="!selectedStatus && !selectedReachability">Select a count from the
                                Summary
                                tab to view details</p>
                        </div>
                        <mat-progress-spinner diameter="30" mode="indeterminate"
                            *ngIf="loadingDetails"></mat-progress-spinner>
                    </div>

                    <div class="actions-row" *ngIf="selectedStatus === 'error' && detailRows.length > 0">
                        <button mat-raised-button color="primary" [disabled]="selectedHostnames.size === 0"
                            (click)="validateSelectedHostnames()">
                            <mat-icon>done_all</mat-icon> Validate Selected ({{selectedHostnames.size}})
                        </button>
                    </div>

                    <table mat-table [dataSource]="detailRows" class="mat-elevation-z1"
                        *ngIf="selectedStatus || selectedReachability">
                        <!-- Select Column -->
                        <ng-container matColumnDef="select">
                            <th mat-header-cell *matHeaderCellDef>
                                <mat-checkbox (change)="$event ? masterToggle() : null"
                                    [checked]="isAllSelected() && detailRows.length > 0"
                                    [indeterminate]="selectedHostnames.size > 0 && !isAllSelected()">
                                </mat-checkbox>
                            </th>
                            <td mat-cell *matCellDef="let row">
                                <mat-checkbox (click)="$event.stopPropagation()"
                                    (change)="$event ? toggleSelection(row.hostname) : null"
                                    [checked]="selectedHostnames.has(row.hostname)">
                                </mat-checkbox>
                            </td>
                        </ng-container>

                        <ng-container matColumnDef="srNo">
                            <th mat-header-cell *matHeaderCellDef>Sr No</th>
                            <td mat-cell *matCellDef="let row; let i = index">{{i + 1}}</td>
                        </ng-container>
                        <ng-container matColumnDef="hostname">
                            <th mat-header-cell *matHeaderCellDef>Hostname</th>
                            <td mat-cell *matCellDef="let row">{{ row.hostname }}</td>
                        </ng-container>
                        <ng-container matColumnDef="ip">
                            <th mat-header-cell *matHeaderCellDef>IP</th>
                            <td mat-cell *matCellDef="let row">{{ row.ip || '—' }}</td>
                        </ng-container>
                        <ng-container matColumnDef="criticality">
                            <th mat-header-cell *matHeaderCellDef>Criticality</th>
                            <td mat-cell *matCellDef="let row">{{ row.mc_criticality || '—' }}</td>
                        </ng-container>
                        <ng-container matColumnDef="updatedBy">
                            <th mat-header-cell *matHeaderCellDef>Updated By</th>
                            <td mat-cell *matCellDef="let row">{{ row.updated_by || '—' }}</td>
                        </ng-container>
                        <ng-container matColumnDef="updatedAt">
                            <th mat-header-cell *matHeaderCellDef>Updated At</th>
                            <td mat-cell *matCellDef="let row">{{ (row.updated_at | date:'medium':'+0530') || '—' }}
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef>Actions</th>
                            <td mat-cell *matCellDef="let row">
                                <button mat-stroked-button color="primary" (click)="showHostnameDetails(row.hostname)"
                                    *ngIf="selectedStatus === 'error'">Details</button>
                                <button mat-stroked-button color="primary" (click)="showHostnameDetails(row.hostname)"
                                    *ngIf="selectedStatus === 'success'">View Commands</button>
                                <button mat-button color="primary" (click)="validateHost(row.hostname)"
                                    *ngIf="selectedStatus === 'error'">Validate</button>
                            </td>
                        </ng-container>

                        <tr mat-header-row
                            *matHeaderRowDef="['select', 'srNo','hostname','ip','criticality','updatedBy','updatedAt','actions']">
                        </tr>
                        <tr mat-row
                            *matRowDef="let row; columns: ['select', 'srNo','hostname','ip','criticality','updatedBy','updatedAt','actions'];">
                        </tr>

                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" [attr.colspan]="6" style="text-align: center; padding: 24px;">
                                <p *ngIf="!loadingDetails">No {{ selectedStatus || selectedReachability }} details
                                    available.</p>
                                <p *ngIf="loadingDetails">Loading...</p>
                            </td>
                        </tr>
                    </table>

                    <div *ngIf="!selectedStatus && !selectedReachability" class="empty-state">
                        <mat-icon style="font-size: 48px; height: 48px; width: 48px; color: #ccc;">toc</mat-icon>
                        <p>Please select a Success or Error count from the Summary tab to view details here.</p>
                    </div>
                </mat-card>
            </div>
        </mat-tab>
        <mat-tab label="Validated Hostnames">
            <div class="tab-content">
                <div class="loading-shade" *ngIf="loadingValidated">
                    <mat-spinner diameter="40"></mat-spinner>
                </div>

                <div class="validated-table-container matt-elevation-z2" *ngIf="!loadingValidated">
                    <table mat-table [dataSource]="validatedItems">
                        <!-- Sr No Column -->
                        <ng-container matColumnDef="srNo">
                            <th mat-header-cell *matHeaderCellDef> Sr No </th>
                            <td mat-cell *matCellDef="let row; let i = index"> {{i + 1}} </td>
                        </ng-container>

                        <!-- Hostname Column -->
                        <ng-container matColumnDef="hostname">
                            <th mat-header-cell *matHeaderCellDef> Hostname </th>
                            <td mat-cell *matCellDef="let row"> {{row.hostname}} </td>
                        </ng-container>

                        <!-- Criticality Column -->
                        <ng-container matColumnDef="mc_criticality">
                            <th mat-header-cell *matHeaderCellDef> Criticality </th>
                            <td mat-cell *matCellDef="let row">
                                <span class="criticality-badge" [ngClass]="(row.mc_criticality || 'low').toLowerCase()">
                                    {{row.mc_criticality || 'Low'}}
                                </span>
                            </td>
                        </ng-container>

                        <!-- Validated At Column -->
                        <ng-container matColumnDef="validated_at">
                            <th mat-header-cell *matHeaderCellDef> Validated At </th>
                            <td mat-cell *matCellDef="let row"> {{row.validated_at | date:'medium':'+0530'}} </td>
                        </ng-container>

                        <!-- Validated By Column -->
                        <ng-container matColumnDef="validated_by">
                            <th mat-header-cell *matHeaderCellDef> Validated By </th>
                            <td mat-cell *matCellDef="let row"> {{row.validate_by}} </td>
                        </ng-container>

                        <!-- Comment Column -->
                        <ng-container matColumnDef="comment">
                            <th mat-header-cell *matHeaderCellDef> Comment </th>
                            <td mat-cell *matCellDef="let row"> {{row.validate_comment || '-'}} </td>
                        </ng-container>

                        <!-- Actions Column -->
                        <ng-container matColumnDef="actions">
                            <th mat-header-cell *matHeaderCellDef> Actions </th>
                            <td mat-cell *matCellDef="let row">
                                <button mat-icon-button color="warn"
                                    (click)="undoValidation(row.hostname, row.mc_check_date)"
                                    matTooltip="Undo Validation">
                                    <mat-icon>undo</mat-icon>
                                </button>
                                <button mat-stroked-button color="primary"
                                    (click)="showHostnameDetails(row.hostname, row.mc_check_date)">
                                    Details
                                </button>
                            </td>
                        </ng-container>

                        <tr mat-header-row
                            *matHeaderRowDef="['srNo', 'hostname', 'mc_criticality', 'validated_at', 'validated_by', 'comment', 'actions']">
                        </tr>
                        <tr mat-row
                            *matRowDef="let row; columns: ['srNo', 'hostname', 'mc_criticality', 'validated_at', 'validated_by', 'comment', 'actions'];">
                        </tr>

                        <!-- Empty State -->
                        <tr class="mat-row" *matNoDataRow>
                            <td class="mat-cell" colspan="6" style="text-align: center; padding: 20px;">
                                No validated hostnames found
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </mat-tab>
    </mat-tab-group>
</div>



<ng-template #hostnameDetailsDialog>
    <h2 mat-dialog-title>Command Details - {{ selectedHostname }}</h2>
    <mat-dialog-content>
        <div class="date-info">
            <div class="date-label">Date D: <strong>{{ getSelectedDateString() }}</strong></div>
            <div class="date-label">Date D-1: <strong>{{ formatPreviousDateString() }}</strong></div>
        </div>

        <div *ngIf="loadingHostnameDetails" class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading command details...</p>
        </div>

        <div *ngIf="!loadingHostnameDetails && selectedHostnameDetails.length === 0" class="empty-state">
            <p>No command data available for this hostname.</p>
        </div>

        <div *ngFor="let cmd of selectedHostnameDetails; let i = index" class="command-block">
            <h3 class="command-title">
                <mat-icon>terminal</mat-icon>
                {{ cmd.command || 'Command ' + (i + 1) }}
                <span class="validated-badge" *ngIf="cmd.is_validated">
                    <mat-icon>check_circle</mat-icon> Validated
                </span>
            </h3>

            <div class="side-by-side-container">
                <div class="sbs-header">
                    <div class="sbs-col">Date D-1 ({{ formatPreviousDateString() }})</div>
                    <div class="sbs-col">Date D ({{ getSelectedDateString() }})</div>
                </div>
                <div class="sbs-content">
                    <div *ngFor="let row of getSideBySideDiff(cmd)" class="sbs-row">
                        <div class="sbs-cell left" [ngClass]="row.left.type">
                            <span class="line-content">{{ row.left.line }}</span>
                        </div>
                        <div class="sbs-cell right" [ngClass]="row.right.type">
                            <span class="line-content">{{ row.right.line }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
        <button mat-stroked-button mat-dialog-close>Close</button>
    </mat-dialog-actions>
</ng-template>