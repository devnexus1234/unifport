<div class="page">
    <mat-card class="filters">
        <div class="row">
            <mat-form-field appearance="outline">
                <mat-label>Start date</mat-label>
                <input matInput [(ngModel)]="filters.start_date" placeholder="YYYY-MM-DD">
            </mat-form-field>
            <mat-form-field appearance="outline">
                <mat-label>End date</mat-label>
                <input matInput [(ngModel)]="filters.end_date" placeholder="YYYY-MM-DD">
            </mat-form-field>
            <mat-form-field appearance="outline">
                <mat-label>Application</mat-label>
                <input matInput [(ngModel)]="filters.application_name" placeholder="Application name">
            </mat-form-field>
            <mat-form-field appearance="outline">
                <mat-label>Asset owner</mat-label>
                <input matInput [(ngModel)]="filters.asset_owner" placeholder="Owner">
            </mat-form-field>
            <mat-form-field appearance="outline">
                <mat-label>Validated by</mat-label>
                <input matInput [(ngModel)]="filters.validated_by" placeholder="User">
            </mat-form-field>
            <mat-form-field appearance="outline">
                <mat-label>Sort by</mat-label>
                <mat-select [(ngModel)]="filters.sort_by">
                    <mat-option value="validated_at">Latest validation</mat-option>
                    <mat-option value="hostname">Hostname</mat-option>
                    <mat-option value="mc_criticality">Criticality</mat-option>
                </mat-select>
            </mat-form-field>
            <button mat-flat-button color="primary" (click)="loadValidated()">
                <mat-icon>search</mat-icon>
                Apply
            </button>
        </div>
    </mat-card>

    <mat-card>
        <div class="card-header">
            <div>
                <h3>Validated Hostnames Summary</h3>
                <p class="subtitle">Latest validation per hostname</p>
            </div>
            <mat-progress-spinner diameter="30" mode="indeterminate" *ngIf="loading"></mat-progress-spinner>
        </div>

        <table mat-table [dataSource]="items" class="mat-elevation-z1">
            <ng-container matColumnDef="hostname">
                <th mat-header-cell *matHeaderCellDef>Hostname</th>
                <td mat-cell *matCellDef="let row">{{ row.hostname }}</td>
            </ng-container>
            <ng-container matColumnDef="ip">
                <th mat-header-cell *matHeaderCellDef>IP</th>
                <td mat-cell *matCellDef="let row">{{ row.ip || '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="application">
                <th mat-header-cell *matHeaderCellDef>Application</th>
                <td mat-cell *matCellDef="let row">{{ row.application_name }}</td>
            </ng-container>
            <ng-container matColumnDef="owner">
                <th mat-header-cell *matHeaderCellDef>Owner</th>
                <td mat-cell *matCellDef="let row">{{ row.asset_owner || '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="criticality">
                <th mat-header-cell *matHeaderCellDef>Criticality</th>
                <td mat-cell *matCellDef="let row">{{ row.mc_criticality || '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="validatedAt">
                <th mat-header-cell *matHeaderCellDef>Validated At</th>
                <td mat-cell *matCellDef="let row">{{ row.validated_at | date:'medium':'+0530' }}</td>
            </ng-container>
            <ng-container matColumnDef="validatedBy">
                <th mat-header-cell *matHeaderCellDef>Validated By</th>
                <td mat-cell *matCellDef="let row">{{ row.validate_by }}</td>
            </ng-container>
            <ng-container matColumnDef="comment">
                <th mat-header-cell *matHeaderCellDef>Comment</th>
                <td mat-cell *matCellDef="let row">{{ row.validate_comment || '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="mode">
                <th mat-header-cell *matHeaderCellDef>Mode</th>
                <td mat-cell *matCellDef="let row">{{ row.is_bulk ? 'Bulk' : 'Single' }}</td>
            </ng-container>
            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let row">
                    <button mat-icon-button color="warn" (click)="undoValidation(row.hostname, row.mc_check_date)"
                        matTooltip="Undo Validation">
                        <mat-icon>undo</mat-icon>
                    </button>
                    <button mat-stroked-button color="primary" (click)="openHistory(row.hostname)">History</button>
                </td>
            </ng-container>

            <tr mat-header-row
                *matHeaderRowDef="['hostname','ip','application','owner','criticality','validatedAt','validatedBy','comment','mode','actions']">
            </tr>
            <tr mat-row
                *matRowDef="let row; columns: ['hostname','ip','application','owner','criticality','validatedAt','validatedBy','comment','mode','actions'];">
            </tr>
        </table>
    </mat-card>
</div>

<ng-template #historyDialog>
    <h2 mat-dialog-title>Validation history - {{ selectedHostname }}</h2>
    <mat-dialog-content>
        <table mat-table [dataSource]="history" class="mat-elevation-z1">
            <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let row">{{ row.mc_check_date }}</td>
            </ng-container>
            <ng-container matColumnDef="validatedAt">
                <th mat-header-cell *matHeaderCellDef>Validated at</th>
                <td mat-cell *matCellDef="let row">{{ row.validated_at }}</td>
            </ng-container>
            <ng-container matColumnDef="validatedBy">
                <th mat-header-cell *matHeaderCellDef>Validated by</th>
                <td mat-cell *matCellDef="let row">{{ row.validate_by }}</td>
            </ng-container>
            <ng-container matColumnDef="comment">
                <th mat-header-cell *matHeaderCellDef>Comment</th>
                <td mat-cell *matCellDef="let row">{{ row.validate_comment || '—' }}</td>
            </ng-container>
            <ng-container matColumnDef="mode">
                <th mat-header-cell *matHeaderCellDef>Mode</th>
                <td mat-cell *matCellDef="let row">{{ row.is_bulk ? 'Bulk' : 'Single' }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['date','validatedAt','validatedBy','comment','mode']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['date','validatedAt','validatedBy','comment','mode'];"></tr>
        </table>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
        <button mat-stroked-button mat-dialog-close>Close</button>
    </mat-dialog-actions>
</ng-template>